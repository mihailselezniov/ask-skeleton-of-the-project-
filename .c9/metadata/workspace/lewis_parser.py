{"filter":false,"title":"lewis_parser.py","tooltip":"/lewis_parser.py","undoManager":{"mark":100,"position":100,"stack":[[{"start":{"row":103,"column":7},"end":{"row":103,"column":8},"action":"insert","lines":["u"],"id":1225}],[{"start":{"row":103,"column":8},"end":{"row":103,"column":9},"action":"insert","lines":["r"],"id":1226}],[{"start":{"row":103,"column":9},"end":{"row":103,"column":10},"action":"insert","lines":["n"],"id":1227}],[{"start":{"row":103,"column":10},"end":{"row":103,"column":11},"action":"insert","lines":[" "],"id":1228}],[{"start":{"row":103,"column":11},"end":{"row":103,"column":12},"action":"insert","lines":["T"],"id":1229}],[{"start":{"row":103,"column":12},"end":{"row":103,"column":13},"action":"insert","lines":["r"],"id":1230}],[{"start":{"row":103,"column":13},"end":{"row":103,"column":14},"action":"insert","lines":["u"],"id":1231}],[{"start":{"row":103,"column":14},"end":{"row":103,"column":15},"action":"insert","lines":["e"],"id":1232}],[{"start":{"row":103,"column":0},"end":{"row":103,"column":15},"action":"remove","lines":["    return True"],"id":1233}],[{"start":{"row":102,"column":23},"end":{"row":103,"column":0},"action":"remove","lines":["",""],"id":1234}],[{"start":{"row":81,"column":32},"end":{"row":81,"column":33},"action":"insert","lines":[","],"id":1235}],[{"start":{"row":81,"column":33},"end":{"row":81,"column":34},"action":"insert","lines":[" "],"id":1236}],[{"start":{"row":81,"column":34},"end":{"row":81,"column":42},"action":"insert","lines":["token_db"],"id":1237}],[{"start":{"row":79,"column":21},"end":{"row":80,"column":0},"action":"insert","lines":["",""],"id":1238},{"start":{"row":80,"column":0},"end":{"row":80,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":80,"column":4},"end":{"row":80,"column":43},"action":"insert","lines":["send_msg_lewis(post_obj, url, token_db)"],"id":1239}],[{"start":{"row":80,"column":19},"end":{"row":80,"column":27},"action":"remove","lines":["post_obj"],"id":1240},{"start":{"row":80,"column":19},"end":{"row":80,"column":21},"action":"insert","lines":["qa"]}],[{"start":{"row":80,"column":23},"end":{"row":80,"column":26},"action":"remove","lines":["url"],"id":1241},{"start":{"row":80,"column":23},"end":{"row":80,"column":34},"action":"insert","lines":["url_nohttps"]}],[{"start":{"row":80,"column":45},"end":{"row":81,"column":0},"action":"remove","lines":["",""],"id":1242}],[{"start":{"row":80,"column":45},"end":{"row":81,"column":0},"action":"insert","lines":["",""],"id":1243},{"start":{"row":81,"column":0},"end":{"row":81,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":81,"column":0},"end":{"row":81,"column":4},"action":"remove","lines":["    "],"id":1244}],[{"start":{"row":81,"column":0},"end":{"row":99,"column":45},"action":"insert","lines":["def send_msg_qa_lewis(qa):","    token_db = Lumiera_variables.query.filter_by(name=\"lumiera_token\").first()","    token = token_db.text","    token_db_secret = Lumiera_variables.query.filter_by(name=\"lumiera_secret_token\").first()","    secret = token_db_secret.text","    #print u'{}\\n\\n{}'.format(qa.question, qa.answer)","    #print unidecode(u'{}\\n\\n{}'.format(qa.question, qa.answer))","    #print str(qa.question.encode('cp1251'))","    ","    #for_md5 = u'/method/messages.send?chat_id=1&access_token={}&message={}%0A%0A{}&captcha_sid=148998187493&captcha_key=vcdykn{}'.format(token, \"mm\", \"kk\", secret)","    for_md5 = u'/method/messages.send?chat_id=1&access_token={}&message=q: {}\\na: {}{}'.format(token, u' '.join(qa.question.split()), u' '.join(qa.answer.split()), secret)","    ","    #print for_md5","    str_md5 = hashlib.md5(for_md5.encode('utf-8')).hexdigest()","    #url_nohttps = u'http://api.vkontakte.ru/method/messages.send?chat_id=1&access_token={}&message={}%0A%0A{}&captcha_sid=148998187493&captcha_key=vcdykn&sig={}'.format(token, \"mm\", \"kk\", str_md5)","    url_nohttps = u'http://api.vk.com/method/messages.send?chat_id=1&access_token={}&message=q:%20{}%0Aa:%20{}&sig={}'.format(token, '%20'.join(qa.question.split()), '%20'.join(qa.answer.split()), str_md5)","    ","    print url_nohttps","    send_msg_lewis(qa, url_nohttps, token_db)"],"id":1245}],[{"start":{"row":81,"column":13},"end":{"row":81,"column":15},"action":"remove","lines":["qa"],"id":1246},{"start":{"row":81,"column":13},"end":{"row":81,"column":14},"action":"insert","lines":["w"]}],[{"start":{"row":81,"column":14},"end":{"row":81,"column":15},"action":"insert","lines":["a"],"id":1247}],[{"start":{"row":81,"column":15},"end":{"row":81,"column":16},"action":"insert","lines":["l"],"id":1248}],[{"start":{"row":81,"column":16},"end":{"row":81,"column":17},"action":"insert","lines":["l"],"id":1249}],[{"start":{"row":86,"column":0},"end":{"row":88,"column":44},"action":"remove","lines":["    #print u'{}\\n\\n{}'.format(qa.question, qa.answer)","    #print unidecode(u'{}\\n\\n{}'.format(qa.question, qa.answer))","    #print str(qa.question.encode('cp1251'))"],"id":1250}],[{"start":{"row":86,"column":0},"end":{"row":89,"column":4},"action":"remove","lines":["","    ","    #for_md5 = u'/method/messages.send?chat_id=1&access_token={}&message={}%0A%0A{}&captcha_sid=148998187493&captcha_key=vcdykn{}'.format(token, \"mm\", \"kk\", secret)","    "],"id":1251}],[{"start":{"row":86,"column":0},"end":{"row":86,"column":4},"action":"insert","lines":["    "],"id":1252}],[{"start":{"row":87,"column":0},"end":{"row":88,"column":18},"action":"remove","lines":["    ","    #print for_md5"],"id":1253}],[{"start":{"row":86,"column":171},"end":{"row":87,"column":0},"action":"remove","lines":["",""],"id":1254}],[{"start":{"row":88,"column":0},"end":{"row":89,"column":4},"action":"remove","lines":["    #url_nohttps = u'http://api.vkontakte.ru/method/messages.send?chat_id=1&access_token={}&message={}%0A%0A{}&captcha_sid=148998187493&captcha_key=vcdykn&sig={}'.format(token, \"mm\", \"kk\", str_md5)","    "],"id":1255}],[{"start":{"row":88,"column":0},"end":{"row":88,"column":4},"action":"insert","lines":["    "],"id":1256}],[{"start":{"row":91,"column":45},"end":{"row":92,"column":0},"action":"insert","lines":["",""],"id":1257},{"start":{"row":92,"column":0},"end":{"row":92,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":80,"column":45},"end":{"row":81,"column":0},"action":"insert","lines":["",""],"id":1258},{"start":{"row":81,"column":0},"end":{"row":81,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":82,"column":24},"end":{"row":82,"column":26},"action":"remove","lines":["qa"],"id":1259},{"start":{"row":82,"column":24},"end":{"row":82,"column":25},"action":"insert","lines":["w"]}],[{"start":{"row":82,"column":25},"end":{"row":82,"column":26},"action":"insert","lines":["a"],"id":1260}],[{"start":{"row":82,"column":26},"end":{"row":82,"column":27},"action":"insert","lines":[";"],"id":1261}],[{"start":{"row":82,"column":26},"end":{"row":82,"column":27},"action":"remove","lines":[";"],"id":1262}],[{"start":{"row":82,"column":26},"end":{"row":82,"column":27},"action":"insert","lines":["l"],"id":1263}],[{"start":{"row":82,"column":27},"end":{"row":82,"column":28},"action":"insert","lines":["l"],"id":1264}],[{"start":{"row":82,"column":28},"end":{"row":82,"column":29},"action":"insert","lines":["_"],"id":1265}],[{"start":{"row":82,"column":29},"end":{"row":82,"column":30},"action":"insert","lines":["i"],"id":1266}],[{"start":{"row":82,"column":30},"end":{"row":82,"column":31},"action":"insert","lines":["d"],"id":1267}],[{"start":{"row":92,"column":19},"end":{"row":92,"column":21},"action":"remove","lines":["qa"],"id":1268},{"start":{"row":92,"column":19},"end":{"row":92,"column":26},"action":"insert","lines":["wall_id"]}],[{"start":{"row":87,"column":46},"end":{"row":87,"column":47},"action":"remove","lines":["1"],"id":1269}],[{"start":{"row":87,"column":46},"end":{"row":87,"column":47},"action":"insert","lines":["2"],"id":1270}],[{"start":{"row":87,"column":64},"end":{"row":87,"column":71},"action":"remove","lines":["message"],"id":1271},{"start":{"row":87,"column":64},"end":{"row":87,"column":74},"action":"insert","lines":["attachment"]}],[{"start":{"row":86,"column":33},"end":{"row":87,"column":0},"action":"insert","lines":["",""],"id":1272},{"start":{"row":87,"column":0},"end":{"row":87,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":87,"column":4},"end":{"row":88,"column":43},"action":"insert","lines":["w_id = wall_id.wall_id","    print u'{}{}'.format(u'wall', w_id[3:])"],"id":1273}],[{"start":{"row":88,"column":4},"end":{"row":88,"column":9},"action":"remove","lines":["print"],"id":1274},{"start":{"row":88,"column":4},"end":{"row":88,"column":14},"action":"insert","lines":["attachment"]}],[{"start":{"row":88,"column":14},"end":{"row":88,"column":15},"action":"insert","lines":[" "],"id":1275}],[{"start":{"row":88,"column":15},"end":{"row":88,"column":16},"action":"insert","lines":["="],"id":1276}],[{"start":{"row":89,"column":105},"end":{"row":89,"column":165},"action":"remove","lines":["u' '.join(qa.question.split()), u' '.join(qa.answer.split())"],"id":1277},{"start":{"row":89,"column":105},"end":{"row":89,"column":115},"action":"insert","lines":["attachment"]}],[{"start":{"row":89,"column":75},"end":{"row":89,"column":85},"action":"remove","lines":["q: {}\\na: "],"id":1278}],[{"start":{"row":91,"column":67},"end":{"row":91,"column":68},"action":"remove","lines":["1"],"id":1279},{"start":{"row":91,"column":67},"end":{"row":91,"column":68},"action":"insert","lines":["2"]}],[{"start":{"row":91,"column":84},"end":{"row":91,"column":110},"action":"remove","lines":["&message=q:%20{}%0Aa:%20{}"],"id":1280},{"start":{"row":91,"column":84},"end":{"row":91,"column":98},"action":"insert","lines":["&attachment={}"]}],[{"start":{"row":91,"column":121},"end":{"row":91,"column":183},"action":"remove","lines":["'%20'.join(qa.question.split()), '%20'.join(qa.answer.split())"],"id":1281},{"start":{"row":91,"column":121},"end":{"row":91,"column":131},"action":"insert","lines":["attachment"]}],[{"start":{"row":128,"column":4},"end":{"row":128,"column":5},"action":"remove","lines":["#"],"id":1282}],[{"start":{"row":128,"column":4},"end":{"row":128,"column":21},"action":"remove","lines":["send_msg_qa_lewis"],"id":1283},{"start":{"row":128,"column":4},"end":{"row":128,"column":32},"action":"insert","lines":["send_msg_wall_lewis(wall_id)"]}],[{"start":{"row":128,"column":35},"end":{"row":128,"column":36},"action":"remove","lines":[")"],"id":1284}],[{"start":{"row":128,"column":34},"end":{"row":128,"column":35},"action":"remove","lines":["a"],"id":1285}],[{"start":{"row":128,"column":33},"end":{"row":128,"column":34},"action":"remove","lines":["q"],"id":1286}],[{"start":{"row":128,"column":32},"end":{"row":128,"column":33},"action":"remove","lines":["("],"id":1287}],[{"start":{"row":126,"column":0},"end":{"row":127,"column":43},"action":"remove","lines":["    w_id = wall_id.wall_id","    print u'{}{}'.format(u'wall', w_id[3:])"],"id":1288}],[{"start":{"row":125,"column":27},"end":{"row":126,"column":0},"action":"remove","lines":["",""],"id":1289}],[{"start":{"row":127,"column":4},"end":{"row":127,"column":5},"action":"remove","lines":["#"],"id":1290}],[{"start":{"row":121,"column":36},"end":{"row":122,"column":0},"action":"insert","lines":["",""],"id":1291}],[{"start":{"row":122,"column":0},"end":{"row":122,"column":35},"action":"insert","lines":["check_lumiera_sprashivai_qa_lewis()"],"id":1292}],[{"start":{"row":122,"column":14},"end":{"row":122,"column":27},"action":"remove","lines":["sprashivai_qa"],"id":1293},{"start":{"row":122,"column":14},"end":{"row":122,"column":15},"action":"insert","lines":["w"]}],[{"start":{"row":122,"column":15},"end":{"row":122,"column":16},"action":"insert","lines":["a"],"id":1294}],[{"start":{"row":122,"column":16},"end":{"row":122,"column":17},"action":"insert","lines":["l"],"id":1295}],[{"start":{"row":122,"column":17},"end":{"row":122,"column":18},"action":"insert","lines":["l"],"id":1296}],[{"start":{"row":123,"column":0},"end":{"row":124,"column":0},"action":"insert","lines":["",""],"id":1297}],[{"start":{"row":124,"column":0},"end":{"row":124,"column":1},"action":"insert","lines":["d"],"id":1298}],[{"start":{"row":124,"column":1},"end":{"row":124,"column":2},"action":"insert","lines":["e"],"id":1299}],[{"start":{"row":124,"column":2},"end":{"row":124,"column":3},"action":"insert","lines":["f"],"id":1300}],[{"start":{"row":124,"column":3},"end":{"row":124,"column":4},"action":"insert","lines":[" "],"id":1301}],[{"start":{"row":124,"column":4},"end":{"row":124,"column":28},"action":"insert","lines":["check_lumiera_wall_lewis"],"id":1302}],[{"start":{"row":124,"column":28},"end":{"row":124,"column":29},"action":"insert","lines":["("],"id":1303}],[{"start":{"row":124,"column":29},"end":{"row":124,"column":30},"action":"insert","lines":[")"],"id":1304}],[{"start":{"row":124,"column":30},"end":{"row":124,"column":31},"action":"insert","lines":[":"],"id":1305}],[{"start":{"row":125,"column":0},"end":{"row":125,"column":4},"action":"insert","lines":["    "],"id":1306},{"start":{"row":126,"column":0},"end":{"row":126,"column":4},"action":"insert","lines":["    "]},{"start":{"row":127,"column":0},"end":{"row":127,"column":4},"action":"insert","lines":["    "]},{"start":{"row":128,"column":0},"end":{"row":128,"column":4},"action":"insert","lines":["    "]},{"start":{"row":129,"column":0},"end":{"row":129,"column":4},"action":"insert","lines":["    "]},{"start":{"row":130,"column":0},"end":{"row":130,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":130,"column":8},"end":{"row":130,"column":9},"action":"remove","lines":["#"],"id":1307}],[{"start":{"row":129,"column":8},"end":{"row":129,"column":9},"action":"insert","lines":["#"],"id":1308}],[{"start":{"row":129,"column":0},"end":{"row":129,"column":14},"action":"remove","lines":["        #break"],"id":1309}],[{"start":{"row":128,"column":36},"end":{"row":129,"column":0},"action":"remove","lines":["",""],"id":1310}],[{"start":{"row":124,"column":0},"end":{"row":129,"column":21},"action":"remove","lines":["def check_lumiera_wall_lewis():","    new_wall_id = Lumiera_wall.query.filter(or_(Lumiera_wall.post == None, Lumiera_wall.post == False))\\","                .order_by(Lumiera_wall.created_at).all()","    for wall_id in new_wall_id:","        send_msg_wall_lewis(wall_id)","        time.sleep(2)"],"id":1311}],[{"start":{"row":61,"column":33},"end":{"row":62,"column":0},"action":"insert","lines":["",""],"id":1312},{"start":{"row":62,"column":0},"end":{"row":62,"column":8},"action":"insert","lines":["        "]}],[{"start":{"row":62,"column":4},"end":{"row":62,"column":8},"action":"remove","lines":["    "],"id":1313}],[{"start":{"row":62,"column":0},"end":{"row":62,"column":4},"action":"remove","lines":["    "],"id":1314}],[{"start":{"row":62,"column":0},"end":{"row":67,"column":21},"action":"insert","lines":["def check_lumiera_wall_lewis():","    new_wall_id = Lumiera_wall.query.filter(or_(Lumiera_wall.post == None, Lumiera_wall.post == False))\\","                .order_by(Lumiera_wall.created_at).all()","    for wall_id in new_wall_id:","        send_msg_wall_lewis(wall_id)","        time.sleep(2)"],"id":1315}],[{"start":{"row":127,"column":0},"end":{"row":127,"column":1},"action":"remove","lines":["#"],"id":1316}],[{"start":{"row":125,"column":19},"end":{"row":126,"column":0},"action":"remove","lines":["",""],"id":1317}],[{"start":{"row":124,"column":0},"end":{"row":124,"column":4},"action":"remove","lines":["    "],"id":1318}],[{"start":{"row":124,"column":0},"end":{"row":125,"column":0},"action":"insert","lines":["",""],"id":1319}],[{"start":{"row":125,"column":0},"end":{"row":151,"column":21},"action":"insert","lines":["while 1:","    try:","        g = ggo(vk_url)","","        # Максималный id","        list_wall_id = g.doc.select(\"//div[@class='wall_text']/div[2]/@id\")","        last_wall_id = list_wall_id[0].text()","","        # Если такой id имееться, то не сохранять ","        wall_id_in_db = Lumiera_wall.query.filter_by(wall_id=last_wall_id).first()","        if wall_id_in_db:","            continue","        ","        # Сохрание в Базу","        for wall_id in list_wall_id[::-1]:","            w_id = wall_id.text()","            wall_id_in_db = Lumiera_wall.query.filter_by(wall_id=w_id).first()","            if not wall_id_in_db:","                new_wall_id = Lumiera_wall(wall_id=w_id)","                db.session.add(new_wall_id)","                db.session.commit()","                time.sleep(2)","                ","        time.sleep(random.randint(10,100))","    except Exception, why:","        #print why","        time.sleep(2)"],"id":1320}],[{"start":{"row":152,"column":0},"end":{"row":154,"column":26},"action":"remove","lines":["sleep_ping_lewis(1)","check_lumiera_sprashivai_qa_lewis()","check_lumiera_wall_lewis()"],"id":1321}],[{"start":{"row":151,"column":21},"end":{"row":152,"column":0},"action":"remove","lines":["",""],"id":1322}],[{"start":{"row":127,"column":8},"end":{"row":146,"column":29},"action":"remove","lines":["g = ggo(vk_url)","","        # Максималный id","        list_wall_id = g.doc.select(\"//div[@class='wall_text']/div[2]/@id\")","        last_wall_id = list_wall_id[0].text()","","        # Если такой id имееться, то не сохранять ","        wall_id_in_db = Lumiera_wall.query.filter_by(wall_id=last_wall_id).first()","        if wall_id_in_db:","            continue","        ","        # Сохрание в Базу","        for wall_id in list_wall_id[::-1]:","            w_id = wall_id.text()","            wall_id_in_db = Lumiera_wall.query.filter_by(wall_id=w_id).first()","            if not wall_id_in_db:","                new_wall_id = Lumiera_wall(wall_id=w_id)","                db.session.add(new_wall_id)","                db.session.commit()","                time.sleep(2)"],"id":1323},{"start":{"row":127,"column":8},"end":{"row":129,"column":26},"action":"insert","lines":["sleep_ping_lewis(1)","check_lumiera_sprashivai_qa_lewis()","check_lumiera_wall_lewis()"]}],[{"start":{"row":128,"column":0},"end":{"row":128,"column":4},"action":"insert","lines":["    "],"id":1324},{"start":{"row":129,"column":0},"end":{"row":129,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":128,"column":0},"end":{"row":128,"column":4},"action":"insert","lines":["    "],"id":1325},{"start":{"row":129,"column":0},"end":{"row":129,"column":4},"action":"insert","lines":["    "]}]]},"ace":{"folds":[],"scrolltop":1611,"scrollleft":0,"selection":{"start":{"row":134,"column":21},"end":{"row":134,"column":21},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":114,"state":"start","mode":"ace/mode/python"}},"timestamp":1442749578811,"hash":"9da2e6cdfea8d6f1e10786eb035f0060665bec45"}